<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <link rel="stylesheet" href="
  https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/atom-one-dark.min.css  
  ">
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Writing the Startup code and Linker Script for the TM4C from scratch &middot; Shawn D'silva
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">


  <!-- Icons -->
  <link rel="logo" sizes="512x512" href="/public/logo.png">
                                 <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body>

    <div class="sidebar">
  <div class="container">
    <div class="sidebar-about">
      <h1>
          Shawn D'silva
      </h1>
      <p class="lead">Embedded software developer and Tinkerer</p>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item" href="/">Home</a>

      

      
      
        
          
        
      
        
          
            <a class="sidebar-nav-item" href="/about/">About</a>
          
        
      
        
      
        
          
        
      


      <a class="sidebar-nav-item fa fa-github"  style="font-size:30px" href="https://github.com/shawn-dsilva"> &nbsp;</a>

     <a class="sidebar-nav-item fa fa-twitter"  style="font-size:30px" href="https://twitter.com/Shade978"> &nbsp;  </a>

    <a class="sidebar-nav-item fa fa-envelope-o"  style="font-size:30px" href="mailto:shawn.dsilva_97@protonmail.com"> &nbsp; </a>


      <p>

          <br>
          &copy; 2018 Shawn D'silva,All Rights Reserved</p>

    </nav>

  </div>
</div>


    <div class="content container">
      <div class="post">
  <h1 class="post-title">Writing the Startup code and Linker Script for the TM4C from scratch</h1>
  <span class="post-date">28 Oct 2018</span>
  <p>Nearly every ARM Cortex-M needs needs a <strong>startup code</strong> file to define it’s  <strong>Main Stack Pointer</strong>, <strong>Reset Handler</strong> and <strong>Vector Table</strong> and a <strong>linker script</strong> telling it to place which sections into which parts of memory,these two files are crucial,without which even a simple blinky program cannot be run.
<br />
Usually,the vendor provided versions of these files are sufficient,but the TI provided ones require a ~500MB download,and registration on the TI website,to top it all off,nearly every file in the TI package has this license in it :</p>

<blockquote>
  <p>Texas Instruments (TI) is supplying this software for use solely and
exclusively on TI’s microcontroller products. The software is owned by
TI and/or its suppliers, and is protected under applicable copyright
laws. You may not combine this software with “viral” open-source
software in order to form a larger program.</p>
</blockquote>

<p>Which is why i decided to write my own Open source startup code and linker script,and document how both
of them work on this blog.</p>

<p><a href="https://shawn-dsilva.github.io/2018/10/28/Writing-the-Startup-code-and-Linker-Script-for-the-TM4C-from-scratch/"><strong>Click here to see full post</strong></a>
<!--more-->
<br /></p>

<h1 id="startup-code">Startup Code</h1>

<p>First we start off with the Startup code,which has two main functions</p>
<ol>
  <li>Initializing the Vector Table with the <code class="highlighter-rouge">Main Stack Pointer</code></li>
  <li>Implementing the <code class="highlighter-rouge">Reset_Handler</code> function,which consists of,
    <ul>
      <li>Copying <code class="highlighter-rouge">.data</code> sections of the memory from Internal Flash to Internal SRAM</li>
      <li>Setting <code class="highlighter-rouge">.bss</code> values to 0</li>
      <li>And finally pointing to the <code class="highlighter-rouge">main()</code> function of your program,after these initialization tasks are done
<br /></li>
    </ul>
  </li>
</ol>

<h2 id="writing--startuph">Writing  Startup.h</h2>
<p>The Vector Table is an array of <code class="highlighter-rouge">void</code> functions which is placed into a section in the memory,namely 
<code class="highlighter-rouge">.vector_table</code> in this case,this name has to also be reflected in the linker script.
The functions each map to an Interrupt index-wise,which is hardcoded into the microcontroller itself,
the interrupt vector table is defined in the TM4C123GH6PM data sheet,pages 147-149,and we will be using it to write our own vector table
<br />
We will be having around ~120 or so function prototypes in our vector table,so we need to aliase undefined function prototypes to a default handler function,we do this by defining a macro in our 
<code class="highlighter-rouge">startup.h</code> file like so
<br /></p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define DEFAULT __attribute__((weak, alias("Default_Handler")))
</span></code></pre></div></div>
<p>This macro, <code class="highlighter-rouge">DEFAULT</code> will expand to <code class="highlighter-rouge">__attribute__((weak, alias("Default_Handler")))</code> which is a command to the GNU GCC compiler to aliase a given function to the <code class="highlighter-rouge">Default_Handler</code> if it is not defined</p>

<p>For example,we are going to explicitly define the <code class="highlighter-rouge">Reset_Handler</code> function prototype in the <code class="highlighter-rouge">startup.c</code> file,but not the <code class="highlighter-rouge">NMI_Handler</code> or other functions for now,so we mark them as <code class="highlighter-rouge">DEFAULT</code></p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="n">Reset_Handler</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="n">DEFAULT</span> <span class="kt">void</span> <span class="n">NMI_Handler</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="n">DEFAULT</span> <span class="kt">void</span> <span class="n">SVC_Handler</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="n">DEFAULT</span> <span class="kt">void</span> <span class="n">DebugMonitor_Handler</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="n">DEFAULT</span> <span class="kt">void</span> <span class="n">PendSV_Handler</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="n">DEFAULT</span> <span class="kt">void</span> <span class="n">SysTick_Handler</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</code></pre></div></div>
<p>We then start writing the ISR function prototypes</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">DEFAULT</span> <span class="kt">void</span> <span class="n">GPIOPortA_ISR</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="n">DEFAULT</span> <span class="kt">void</span> <span class="n">GPIOPortB_ISR</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="n">DEFAULT</span> <span class="kt">void</span> <span class="n">GPIOPortC_ISR</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="n">DEFAULT</span> <span class="kt">void</span> <span class="n">GPIOPortD_ISR</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="n">DEFAULT</span> <span class="kt">void</span> <span class="n">GPIOPortE_ISR</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="n">DEFAULT</span> <span class="kt">void</span> <span class="n">UART0_ISR</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="n">DEFAULT</span> <span class="kt">void</span> <span class="n">UART1_ISR</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="n">DEFAULT</span> <span class="kt">void</span> <span class="n">SPI0_ISR</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="n">DEFAULT</span> <span class="kt">void</span> <span class="n">I2C0_ISR</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="n">DEFAULT</span> <span class="kt">void</span> <span class="n">PWM0Fault_ISR</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="n">DEFAULT</span> <span class="kt">void</span> <span class="n">PWM0Generator0_ISR</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="p">.........</span>
</code></pre></div></div>
<p>The rest of the ISR prototypes can be viewed on my <a href="https://github.com/shawn-dsilva/tm4c-linux-template.git">Github Repo(tm4c-linux-template)</a>,these prototypes conform to the <strong>Interrupt
Vector Table</strong> interrupts from the datasheet</p>

<p><br />
These function prototypes are of return type <code class="highlighter-rouge">void</code>,and standard arrays cannot be declared as void,so we need to define new types for these</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">typedef</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">element_t</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>
</code></pre></div></div>
<p>Here, <code class="highlighter-rouge">*element_t</code> is a pointer passed to void function and cast as void
<br />
next we define a <code class="highlighter-rouge">union</code> for our main stack pointer and our ISRs</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">typedef</span> <span class="k">union</span> <span class="p">{</span>
    <span class="n">element_t</span> <span class="n">isr</span><span class="p">;</span>   
    <span class="kt">void</span> <span class="o">*</span><span class="n">stack_top</span><span class="p">;</span> 
<span class="p">}</span> <span class="n">vector_table_t</span><span class="p">;</span>
</code></pre></div></div>
<p><code class="highlighter-rouge">void *stack_top</code> is a pointer to the top of the stack,and the 0th element of the vector table.
<code class="highlighter-rouge">element_t isr</code> stands for the void functions that will be added to the vector table</p>

<p><br />
Lastly,we have to declare external variables,mainly the sections,and the <code class="highlighter-rouge">main()</code> program entry point</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">extern</span> <span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="k">extern</span> <span class="kt">uint32_t</span> <span class="n">_stack_ptr</span><span class="p">;</span>
<span class="k">extern</span> <span class="kt">uint32_t</span> <span class="n">_etext</span><span class="p">;</span>
<span class="k">extern</span> <span class="kt">uint32_t</span> <span class="n">_data</span><span class="p">;</span>
<span class="k">extern</span> <span class="kt">uint32_t</span> <span class="n">_edata</span><span class="p">;</span>
<span class="k">extern</span> <span class="kt">uint32_t</span> <span class="n">_bss</span><span class="p">;</span>
<span class="k">extern</span> <span class="kt">uint32_t</span> <span class="n">_ebss</span><span class="p">;</span>
</code></pre></div></div>
<p>here the <code class="highlighter-rouge">extern</code> keyword simply tells to compiler to look for these keywords in another file external to this,the <code class="highlighter-rouge">uint32_t</code> means an unsigned,32 bit integer,to dispel ambiquity of int sizes on different architectures.<br />
<code class="highlighter-rouge">int main(void)</code> is the entry point to your <code class="highlighter-rouge">main()</code> program.<br />
<code class="highlighter-rouge">_stack_ptr</code> is the pointer to the top of the stack,i.e the last address of RAM,this is defined in the linker script.<br />
<code class="highlighter-rouge">_data</code> is the start of the <code class="highlighter-rouge">.data</code> section,and <code class="highlighter-rouge">_edata</code> is the end of the <code class="highlighter-rouge">.data</code> section,same convention applies to the other section variables too.</p>

<h2 id="writing-startupc">Writing Startup.c</h2>

<p>We start by including our <code class="highlighter-rouge">startup.h</code> header file with out definitions and the <code class="highlighter-rouge">&lt;stdint.h&gt;</code></p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdint.h&gt;
#include "startup.h"
</span></code></pre></div></div>
<p>Next we direct the compiler to place the following vector table into the section <code class="highlighter-rouge">.vector_table</code> 
in the <code class="highlighter-rouge">.data</code> segment</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">__attribute__</span><span class="p">((</span><span class="n">section</span><span class="p">(</span><span class="s">".vector_table"</span><span class="p">)))</span> 
</code></pre></div></div>
<p><br /></p>

<p>Now we define our vector table like so</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">const</span> <span class="n">vector_table_t</span> <span class="n">vectors</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="p">{.</span><span class="n">stack_top</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">_stack_ptr</span><span class="p">},</span>
<span class="n">Reset_Handler</span><span class="p">,</span>        
<span class="n">NMI_Handler</span><span class="p">,</span>          
<span class="n">HardFault_Handler</span><span class="p">,</span>    
<span class="n">MemManageFault_Handler</span><span class="p">,</span>
<span class="n">BusFault_Handler</span><span class="p">,</span>           
<span class="n">UsageFault_Handler</span><span class="p">,</span>         
<span class="mi">0</span><span class="p">,</span>                          
<span class="mi">0</span><span class="p">,</span>                          
<span class="mi">0</span><span class="p">,</span>                          
<span class="mi">0</span><span class="p">,</span>                          
<span class="n">SVC_Handler</span><span class="p">,</span>                
<span class="n">DebugMonitor_Handler</span><span class="p">,</span>       
<span class="mi">0</span><span class="p">,</span>                          
<span class="n">PendSV_Handler</span><span class="p">,</span>             
<span class="n">SysTick_Handler</span><span class="p">,</span>            
<span class="n">GPIOPortA_ISR</span><span class="p">,</span>              
<span class="n">GPIOPortB_ISR</span><span class="p">,</span>              
<span class="n">GPIOPortC_ISR</span><span class="p">,</span>              
<span class="n">GPIOPortD_ISR</span><span class="p">,</span>              
<span class="n">GPIOPortE_ISR</span><span class="p">,</span>              
<span class="n">UART0_ISR</span><span class="p">,</span>                  
<span class="n">UART1_ISR</span><span class="p">,</span>                  
<span class="n">SPI0_ISR</span><span class="p">,</span>                   
    <span class="cm">/*MORE ISRS FOLLOW FROM HERE */</span>
<span class="p">};</span>
</code></pre></div></div>
<p>Here,</p>
<ul>
  <li>The 0th element,<code class="highlighter-rouge">{.stack_top = &amp;_stack_ptr}</code> assigns the  Main Stack Pointer defined in the Linker Script, <code class="highlighter-rouge">_stack_ptr</code>
to the union element <code class="highlighter-rouge">.stack_top</code> defined in <code class="highlighter-rouge">vector_table_t</code></li>
  <li>The 1st element is the <code class="highlighter-rouge">Reset_Handler</code>,that is called when the <RESET> Button on the microcontroller is pressed,or the reset flag is set
<br /></RESET></li>
</ul>

<p>Finally we define the <code class="highlighter-rouge">Reset_Handler</code> and <code class="highlighter-rouge">Default_Hanlder</code></p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">Reset_Handler</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>

  <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="o">*</span><span class="n">dest</span><span class="p">;</span>


  <span class="n">src</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">_etext</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">dest</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">_data</span><span class="p">;</span> <span class="n">dest</span> <span class="o">&lt;</span> <span class="o">&amp;</span><span class="n">_edata</span><span class="p">;)</span>
  <span class="p">{</span>
    <span class="o">*</span><span class="n">dest</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span><span class="o">++</span><span class="p">;</span>
  <span class="p">}</span>


  <span class="k">for</span> <span class="p">(</span><span class="n">dest</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">_bss</span><span class="p">;</span> <span class="n">dest</span> <span class="o">&lt;</span> <span class="o">&amp;</span><span class="n">_ebss</span><span class="p">;)</span>
  <span class="p">{</span>
    <span class="o">*</span><span class="n">dest</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">main</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>
<p>In this function,</p>
<ul>
  <li>Two pointers are declared, <code class="highlighter-rouge">*src</code> and <code class="highlighter-rouge">*dest</code></li>
  <li><code class="highlighter-rouge">*src</code> is set to the address of <code class="highlighter-rouge">_etext</code>,and in the first loop <code class="highlighter-rouge">*dest</code>
is set to the address of <code class="highlighter-rouge">_data</code></li>
  <li>Till <code class="highlighter-rouge">dest</code> reaches the end of <code class="highlighter-rouge">edata</code> it will loop and copy the contents of <code class="highlighter-rouge">*src</code> into it</li>
  <li>This is copying the data from <code class="highlighter-rouge">.data</code> residing on the Flash,to the RAM</li>
  <li><code class="highlighter-rouge">dest</code> is now set to the address of <code class="highlighter-rouge">_bss</code> and every element of <code class="highlighter-rouge">dest</code>,i.e <code class="highlighter-rouge">_bss</code> is now being set to <code class="highlighter-rouge">0</code></li>
  <li>Lastly,your <code class="highlighter-rouge">main()</code> is called,and control handed over to it
<br /></li>
</ul>

<p><code class="highlighter-rouge">Default_Handler</code> is also defined here,and it just infinitely loops when called</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">Default_Handler</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="p">{}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><strong>With this,we are finally done writing the startup code</strong></p>

<p>The rest of the code can be viewed on my <a href="https://github.com/shawn-dsilva/tm4c-linux-template.git"><strong>Github Repo(tm4c-linux-template)</strong></a></p>

</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/2018/10/17/Getting-Started-with-TM4C-Launchpad-On-Linux/">
            Getting started with the TM4C Launchpad on Linux
            <small>17 Oct 2018</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

    </div>

  </body>
</html>
